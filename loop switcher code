#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// --- LCD setup ---
LiquidCrystal_I2C lcd(0x27, 16, 2);

// --- Pin mapping ---
const byte footPins[4] = {2, 3, 4, 5}; // Footswitch inputs
const byte loopPins[4]  = {8, 9, 10, 11}; // Loops via ULN2803
const byte mutePin      = 7;  // Mute MOSFET control
const byte ledPins[4]   = {12, 13, A0, A1}; // LED cathode controls (ULN2803)

// --- State variables ---
bool loopState[4] = {false, false, false, false};
unsigned long lastPress[4] = {0,0,0,0};
int footPrev[4] = {HIGH, HIGH, HIGH, HIGH};
const unsigned long debounce = 150;
const unsigned int muteTime = 40; // ms mute window

void setup() {
  // Inputs
  for (byte i=0;i<4;i++) {
    pinMode(footPins[i], INPUT_PULLUP);
  }
  
  // Outputs (ULN2803 inputs)
  pinMode(mutePin, OUTPUT);
  digitalWrite(mutePin, LOW); // ULN sinks => mute off

  for (byte i=0;i<4;i++) {
    pinMode(loopPins[i], OUTPUT);
    digitalWrite(loopPins[i], LOW); // ULN sinks => loops off
    pinMode(ledPins[i], OUTPUT);
    digitalWrite(ledPins[i], LOW);  // LED off (ULN sinks)
  }

  lcd.init();
  lcd.backlight();
  lcd.setCursor(0,0);
  lcd.print("FX Switcher Ready");
  delay(1000);
  lcd.clear();
  updateLCD();
}

void loop() {
  unsigned long now = millis();
  for (byte i=0;i<4;i++) {
    int state = digitalRead(footPins[i]);
    if (footPrev[i] == HIGH && state == LOW) {
      if (now - lastPress[i] > debounce) {
        lastPress[i] = now;
        toggleLoop(i);
      }
    }
    if (state == HIGH && footPrev[i] == LOW) {
      lastPress[i] = now; // ensure debounce period starts after release as well
    }
    footPrev[i] = state;
  }
}

void toggleLoop(byte ch) {
  // --- engage mute ---
  digitalWrite(mutePin, HIGH);  // activate ULN sink to mute output
  delay(muteTime);

  // toggle state
  loopState[ch] = !loopState[ch];
  applyState(ch);

  // --- unmute ---
  delay(muteTime);
  digitalWrite(mutePin, LOW);

  updateLCD();
}

void applyState(byte ch) {
  // Loop logic is inverted (HIGH=ON)
  digitalWrite(loopPins[ch], loopState[ch] ? HIGH : LOW);
  digitalWrite(ledPins[ch], loopState[ch] ? HIGH : LOW);
}

void updateLCD() {
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("Loops:");
  for (byte i=0;i<4;i++) {
    lcd.setCursor(6+i,0);
    lcd.print(loopState[i] ? '1' : '0');
  }
}
